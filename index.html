<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Store Manager - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        body {
            font-feature-settings: "kern" 1;
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold">AI-Store Manager</h1>
            <div class="flex items-center space-x-4">
                <div id="statusIndicator" class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-gray-600 mr-2"></div>
                    <span id="statusText" class="font-medium">Stopped</span>
                </div>
                <button id="toggleBtn" onclick="toggleSystem()" 
                    class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                    Start System
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
                    <h2 class="text-2xl font-bold mb-4">Live Camera Feed</h2>
                    
                    <div class="relative bg-black rounded-lg overflow-hidden border border-gray-800">
                        <video id="video" autoplay playsinline class="w-full" style="transform: scaleX(-1); display: block;"></video>
                        
                        <canvas id="overlayCanvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                        
                        <div id="overlay" class="absolute top-4 left-4 right-4 bg-black bg-opacity-90 rounded-lg p-4 border border-gray-700" style="display: none;">
                            <div id="overlayContent"></div>
                        </div>
                        
                        <div id="processingIndicator" class="absolute bottom-4 right-4 bg-yellow-600 px-4 py-2 rounded-lg font-semibold" style="display: none;">
                            Processing...
                        </div>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                            <p class="text-gray-400 text-sm mb-1 font-medium">Total Scans</p>
                            <p class="text-3xl font-bold" id="totalScans">0</p>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                            <p class="text-gray-400 text-sm mb-1 font-medium">Customers</p>
                            <p class="text-3xl font-bold" id="customerCount">0</p>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                            <p class="text-gray-400 text-sm mb-1 font-medium">Employees</p>
                            <p class="text-3xl font-bold" id="employeeCount">0</p>
                        </div>
                    </div>
                    
                    <canvas id="canvas" style="display: none;"></canvas>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
                    <h2 class="text-xl font-bold mb-4">Latest Detection</h2>
                    <div id="latestDetection" class="text-center text-gray-500 py-8">
                        Waiting for detection...
                    </div>
                </div>
                
                <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Detection Log</h2>
                        <button onclick="clearLog()" class="text-sm text-red-400 hover:text-red-300 font-medium transition-colors">Clear</button>
                    </div>
                    <div id="detectionLog" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-sm text-center py-4">No detections yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let stream = null;
        let isRunning = false;
        const scanInterval = 1000;
        let scanIntervalId = null;
        let totalScans = 0;
        let customerCount = 0;
        let employeeCount = 0;
        let detectionLog = [];
        let activePeople = new Map();
        let lastNotificationTime = new Map();
        let loggedPeople = new Set();
        const NOTIFICATION_COOLDOWN = 10000;
        
        function playBeep(role) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Employee: higher pitch (1000Hz), Customer: mid pitch (600Hz)
            oscillator.frequency.value = role === 'Employee' ? 1000 : 600;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                video.addEventListener('loadedmetadata', () => {
                    const overlayCanvas = document.getElementById('overlayCanvas');
                    overlayCanvas.width = video.videoWidth;
                    overlayCanvas.height = video.videoHeight;
                });
                
                return true;
                
            } catch (error) {
                alert('Camera access denied: ' + error.message);
                return false;
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                document.getElementById('video').srcObject = null;
            }
        }
        
        function drawBoundingBoxes(detections) {
            const video = document.getElementById('video');
            const overlayCanvas = document.getElementById('overlayCanvas');
            const ctx = overlayCanvas.getContext('2d');
            
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            const scaleX = overlayCanvas.width / video.videoWidth;
            const scaleY = overlayCanvas.height / video.videoHeight;
            
            detections.forEach(detection => {
                const bbox = detection.bbox;
                const x1 = bbox.x1 * scaleX;
                const y1 = bbox.y1 * scaleY;
                const width = (bbox.x2 - bbox.x1) * scaleX;
                const height = (bbox.y2 - bbox.y1) * scaleY;
                
                const flippedX = overlayCanvas.width - x1 - width;
                
                // Color based on role: Employee (Gold), Customer New (Blue), Customer Match (Green)
                let color;
                if (detection.role === 'Employee') {
                    color = '#fbbf24'; // Gold/Yellow for employees
                } else if (detection.is_match) {
                    color = '#10b981'; // Green for returning customers
                } else {
                    color = '#3b82f6'; // Blue for new customers
                }
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(flippedX, y1, width, height);
                
                // Label with role badge
                const labelBg = color;
                const roleBadge = detection.role === 'Employee' ? ' üëî STAFF' : '';
                const labelText = `${detection.person_id}${roleBadge} (${(detection.confidence_score * 100).toFixed(1)}%)`;
                
                ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                const textMetrics = ctx.measureText(labelText);
                const textWidth = textMetrics.width;
                const textHeight = 20;
                
                ctx.fillStyle = labelBg;
                ctx.fillRect(flippedX, y1 - textHeight - 5, textWidth + 10, textHeight + 5);
                
                ctx.fillStyle = '#000000';
                ctx.fillText(labelText, flippedX + 5, y1 - 8);
            });
        }
        
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit'
            });
        }
        
        async function captureAndRecognize() {
            if (!isRunning) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
            
            document.getElementById('processingIndicator').style.display = 'block';
            
            try {
                const response = await fetch(`${API_URL}/detection/recognize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_base64: imageBase64,
                        location: 'Auto Camera',
                        increment_detection: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.detections && data.detections.length > 0) {
                    totalScans++;
                    
                    const currentPeopleIds = new Set();
                    const newDetections = [];
                    
                    data.detections.forEach(detection => {
                        currentPeopleIds.add(detection.person_id);
                        
                        const now = Date.now();
                        const isNewPerson = !activePeople.has(detection.person_id);
                        
                        // Update role-based counters
                        if (isNewPerson) {
                            if (detection.role === 'Employee') {
                                employeeCount++;
                            } else {
                                customerCount++;
                            }
                        }
                        
                        const lastNotified = lastNotificationTime.get(detection.person_id) || 0;
                        const shouldNotify = isNewPerson || (now - lastNotified) > NOTIFICATION_COOLDOWN;
                        
                        if (shouldNotify) {
                            newDetections.push(detection);
                            lastNotificationTime.set(detection.person_id, now);
                            playBeep(detection.role);
                            
                            if (!loggedPeople.has(detection.person_id)) {
                                addToLog(detection);
                                loggedPeople.add(detection.person_id);
                            }
                        }
                        
                        activePeople.set(detection.person_id, {
                            ...detection,
                            lastSeen: now
                        });
                    });
                    
                    const peopleToRemove = [];
                    activePeople.forEach((value, key) => {
                        if (!currentPeopleIds.has(key)) {
                            peopleToRemove.push(key);
                        }
                    });
                    peopleToRemove.forEach(id => {
                        activePeople.delete(id);
                        lastNotificationTime.delete(id);
                    });
                    
                    drawBoundingBoxes(data.detections);
                    
                    if (newDetections.length > 0) {
                        displayDetection(newDetections);
                    }
                    
                    updateCounters();
                }
                
            } catch (error) {
                console.error('Recognition error:', error);
            } finally {
                document.getElementById('processingIndicator').style.display = 'none';
            }
        }
        
        function displayDetection(detections) {
            const latestDetection = document.getElementById('latestDetection');
            const overlay = document.getElementById('overlay');
            const overlayContent = document.getElementById('overlayContent');
            
            const content = detections.map(detection => {
                // Employee: Gold, Customer Match: Green, Customer New: Blue
                let matchClass, matchText, roleBadge;
                if (detection.role === 'Employee') {
                    matchClass = 'bg-yellow-900 border-yellow-600';
                    matchText = 'STAFF';
                    roleBadge = 'üëî Employee';
                } else if (detection.is_match) {
                    matchClass = 'bg-green-900 border-green-700';
                    matchText = 'Match';
                    roleBadge = 'üõçÔ∏è Customer';
                } else {
                    matchClass = 'bg-blue-900 border-blue-700';
                    matchText = 'New';
                    roleBadge = 'üõçÔ∏è Customer';
                }
                
                return `
                    <div class="${matchClass} border-2 rounded-lg p-4 mb-2">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-2xl font-bold text-white">${matchText}</span>
                            <span class="text-sm font-semibold text-white bg-black bg-opacity-30 px-2 py-1 rounded">${roleBadge}</span>
                        </div>
                        <p class="text-xl font-bold mb-3 text-white">${detection.person_id}</p>
                        <div class="space-y-2 text-sm">
                            ${detection.is_match ? `
                                <div class="flex justify-between">
                                    <span class="text-gray-300">First Seen:</span>
                                    <span class="font-semibold text-white">${formatDateTime(detection.first_seen)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">Last Seen:</span>
                                    <span class="font-semibold text-white">${formatDateTime(detection.last_seen)}</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between">
                                <span class="text-gray-300">Confidence:</span>
                                <span class="font-semibold text-white">${(detection.confidence_score * 100).toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Total Detections:</span>
                                <span class="font-semibold text-white">${detection.total_detections}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            latestDetection.innerHTML = content;
            
            overlayContent.innerHTML = detections.map(detection => {
                const matchText = detection.role === 'Employee' ? 'STAFF' : (detection.is_match ? 'MATCH' : 'NEW');
                const roleBadge = detection.role === 'Employee' ? 'üëî' : 'üõçÔ∏è';
                
                return `
                    <div class="mb-2">
                        <p class="text-2xl font-bold">${roleBadge} ${matchText}: ${detection.person_id}</p>
                        <p class="text-sm text-gray-300">Confidence: ${(detection.confidence_score * 100).toFixed(1)}%</p>
                    </div>
                `;
            }).join('');
            
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 3000);
        }
        
        function addToLog(detection) {
            const logEntry = {
                timestamp: new Date(),
                person_id: detection.person_id,
                is_match: detection.is_match,
                confidence: detection.confidence_score,
                total_detections: detection.total_detections,
                role: detection.role
            };
            
            detectionLog.unshift(logEntry);
            
            if (detectionLog.length > 50) {
                detectionLog = detectionLog.slice(0, 50);
            }
            
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logContainer = document.getElementById('detectionLog');
            
            if (detectionLog.length === 0) {
                logContainer.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No detections yet</p>';
                return;
            }
            
            logContainer.innerHTML = detectionLog.map(entry => {
                let matchClass, matchText, roleIcon;
                if (entry.role === 'Employee') {
                    matchClass = 'bg-yellow-900 border-yellow-600';
                    matchText = 'STAFF';
                    roleIcon = 'üëî';
                } else if (entry.is_match) {
                    matchClass = 'bg-green-900 border-green-700';
                    matchText = 'MATCH';
                    roleIcon = 'üõçÔ∏è';
                } else {
                    matchClass = 'bg-blue-900 border-blue-700';
                    matchText = 'NEW';
                    roleIcon = 'üõçÔ∏è';
                }
                
                return `
                    <div class="${matchClass} border-l-4 rounded p-3">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-bold text-sm mb-1 text-white">${roleIcon} ${matchText}</p>
                                <p class="font-semibold text-sm text-white">${entry.person_id}</p>
                                <p class="text-xs text-gray-300 mt-1">${entry.timestamp.toLocaleTimeString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-bold text-white">${(entry.confidence * 100).toFixed(1)}%</p>
                                <p class="text-xs text-gray-300 mt-1">Count: ${entry.total_detections}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function clearLog() {
            if (confirm('Clear detection log?')) {
                detectionLog = [];
                loggedPeople.clear();
                updateLogDisplay();
            }
        }
        
        function updateCounters() {
            document.getElementById('totalScans').textContent = totalScans;
            document.getElementById('customerCount').textContent = customerCount;
            document.getElementById('employeeCount').textContent = employeeCount;
        }
        
        function startScanning() {
            scanIntervalId = setInterval(captureAndRecognize, scanInterval);
        }
        
        function stopScanning() {
            if (scanIntervalId) {
                clearInterval(scanIntervalId);
                scanIntervalId = null;
            }
        }
        
        async function toggleSystem() {
            const toggleBtn = document.getElementById('toggleBtn');
            const statusIndicator = document.getElementById('statusIndicator').querySelector('div');
            const statusText = document.getElementById('statusText');
            
            if (!isRunning) {
                const cameraStarted = await startCamera();
                
                if (cameraStarted) {
                    isRunning = true;
                    toggleBtn.textContent = 'Stop System';
                    toggleBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    statusIndicator.classList.remove('bg-gray-600');
                    statusIndicator.classList.add('bg-green-500', 'animate-pulse');
                    statusText.textContent = 'Running';
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    startScanning();
                }
            } else {
                isRunning = false;
                stopScanning();
                stopCamera();
                
                activePeople.clear();
                lastNotificationTime.clear();
                
                const overlayCanvas = document.getElementById('overlayCanvas');
                const ctx = overlayCanvas.getContext('2d');
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                
                toggleBtn.textContent = 'Start System';
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                toggleBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                statusIndicator.classList.remove('bg-green-500', 'animate-pulse');
                statusIndicator.classList.add('bg-gray-600');
                statusText.textContent = 'Stopped';
            }
        }
        
        window.addEventListener('beforeunload', () => {
            stopScanning();
            stopCamera();
        });
    </script>
</body>
</html>